name: Test code

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # pre-commit:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up Python
  #       uses: actions/setup-python@v4
  #       with:
  #         python-version: "3.11"
  #         cache: "pip"
  #         cache-dependency-path: pyproject.toml
  #     - name: Test pre-commit hooks
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install pre-commit
  #         pre-commit run -a
  # test_code_pip:
  #   runs-on: ${{ matrix.os }}
  #   strategy:
  #     fail-fast: false
  #     max-parallel: 12
  #     matrix:
  #       python-version: ['3.11']
  #       os: [ubuntu-latest]
  #       plugin: [femwell, gmsh, meow, sax, tidy3d, klayout, vlsir]

  #   name: Test ${{ matrix.plugin }} on ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/cache@v3
  #       with:
  #         path: |
  #           ~/.cache/pip
  #         key: ${{ hashFiles('pyproject.toml') }}
  #     - name: Set up Python ${{ matrix.python-version }}
  #       uses: actions/setup-python@v4
  #       with:
  #         python-version: ${{ matrix.python-version }}
  #     - name: Install dependencies
  #       run: |
  #         make gmsh
  #         pip install -e .[${{ matrix.plugin }},dev]
  #     - name: Test with pytest
  #       env:
  #         SIMCLOUD_APIKEY: ${{ secrets.SIMCLOUD_APIKEY }}
  #         GDSFACTORY_DISPLAY_TYPE: klayout
  #       run: pytest gplugins/${{ matrix.plugin }}
  # test_code_conda:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: conda-incubator/setup-miniconda@v2
  #       with:
  #         python-version: '3.10'
  #         mamba-version: "*"
  #         conda-version: '23.7.4'
  #         channels: conda-forge,defaults
  #         channel-priority: true
  #         activate-environment: anaconda-client-env
  #     - name: Add conda to system path
  #       run: |
  #         echo $CONDA/bin >> $GITHUB_PATH
  #     - name: Install dependencies
  #       run: |
  #         pip install -e .[dev]
  #     - name: Test with pytest
  #       run: |
  #         make meep
  #         pytest gplugins/gmeep gplugins/modes
  # test_non_pip:
  #   runs-on: ${{ matrix.os }}
  #   strategy:
  #     fail-fast: false
  #     max-parallel: 2
  #     matrix:
  #       os: [ubuntu-latest]
  #       plugin: [elmer]
  #   name: Test ${{ matrix.plugin }} on ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/cache@v3
  #       with:
  #         path: |
  #           ~/.cache/pip
  #         key: ${{ hashFiles('pyproject.toml') }}
  #     - uses: actions/setup-python@v4
  #       with:
  #         python-version: 3.11
  #     - name: Install dependencies
  #       run: |
  #         make gmsh
  #         make ${{ matrix.plugin }}
  #         pip install -e .[dev,gmsh]
  #     - name: Test with pytest
  #       env:
  #         GDSFACTORY_DISPLAY_TYPE: klayout
  #       run: pytest gplugins/${{ matrix.plugin }}
  # test_code_coverage:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: conda-incubator/setup-miniconda@v2
  #       with:
  #         python-version: '3.11'
  #         mamba-version: "*"
  #         conda-version: '23.7.4'
  #         channels: conda-forge,defaults
  #         channel-priority: true
  #         activate-environment: anaconda-client-env
  #     - name: Add conda to system path
  #       run: |
  #         echo $CONDA/bin >> $GITHUB_PATH
  #     - name: Install dependencies
  #       run: |
  #         make dev
  #         pip freeze > requirements.txt
  #     - uses: actions/upload-artifact@v3
  #       with:
  #         name: requirements
  #         path: requirements.txt
  #     - name: Test with pytest
  #       env:
  #         SIMCLOUD_APIKEY: ${{ secrets.SIMCLOUD_APIKEY }}
  #         GDSFACTORY_DISPLAY_TYPE: klayout
  #       run: |
  #         make cov
  #     - name: Upload coverage to Codecov
  #       uses: codecov/codecov-action@v3
  #       with:
  #         token: ${{ secrets.CODECOV_TOKEN }}
  #         fail_ci_if_error: false
  nb:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        notebook:
          - notebooks/meshing_01_intro
          - notebooks/meshing_02_2D_xy_mesh
          - notebooks/meshing_03_2D_uz_mesh
          - notebooks/meshing_04_refinement
          - notebooks/meshing_05_3D
          - notebooks/femwell_02_heater
          - notebooks/tcad_02_analytical_process
          - notebooks/tcad_03_numerical_implantation
          - notebooks/femwell_01_modes
          - notebooks/tidy3d_01_tidy3d_modes
          - notebooks/meow_01
          - notebooks/tidy3d_00_tidy3d
          - notebooks/sax_01_sax
          - notebooks/sax_03_variability_analysis
          - notebooks/vlsir_netlist
          - notebooks/20_schematic_driven_layout
          - notebooks/klayout_dataprep
          - notebooks/klayout_drc
          - notebooks/11_get_netlist
          - notebooks/11_get_netlist_spice
          - notebooks/path_length_analysis
          - notebooks/workflow_1_mzi
          - notebooks/workflow_2_ring
          - notebooks/workflow_3_cascaded_mzi
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v3
        with:
          path: |
            ~/.gdsfactory/
          key: 0.0.1
          restore-keys: 0.0.1
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - name: Install dependencies
        run: |
          make dev
      - name: Test documentation
        env:
          SIMCLOUD_APIKEY: ${{ secrets.SIMCLOUD_APIKEY }}
          GDSFACTORY_DISPLAY_TYPE: klayout
        run: |
          jupytext docs/${{ matrix.notebook }}.py --to ipynb
          papermill docs/${{ matrix.notebook }}.ipynb docs/${{ matrix.notebook }}.ipynb
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: notebooks
          path: |
            docs/${{ matrix.notebook}}.ipynb
          retention-days: 1
  nb-no-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          pip install jupytext
      - name: Test documentation
        env:
          SIMCLOUD_APIKEY: ${{ secrets.SIMCLOUD_APIKEY }}
          GDSFACTORY_DISPLAY_TYPE: klayout
        run: |
          jupytext docs/notebooks/ray_optimiser.py --to ipynb
          jupytext docs/notebooks/pso.py --to ipynb
          jupytext docs/notebooks/devsim_01_pin_waveguide.py --to ipynb
          jupytext docs/notebooks/mpb_001_mpb_waveguide.py --to ipynb
          jupytext docs/notebooks/fdtdz_01.py --to ipynb
          jupytext docs/notebooks/meep_01_sparameters.py --to ipynb
          jupytext docs/notebooks/meep_02_gratings.py --to ipynb
          jupytext docs/notebooks/meep_03_fields.py --to ipynb
          jupytext docs/notebooks/mpb_001_mpb_waveguide.py --to ipynb
          jupytext docs/notebooks/lumerical_2_interconnect.py --to ipynb
          jupytext docs/notebooks/lumerical_1_fdtd_sparameters.py --to ipynb
          jupytext docs/notebooks/elmer_01_electrostatic.py --to ipynb
          jupytext docs/notebooks/palace_02_fullwave.py --to ipynb
          jupytext docs/notebooks/palace_01_electrostatic.py --to ipynb
          jupytext docs/notebooks/sax_02_model_extraction.py --to ipynb
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: notebooks
          path: |
            docs/*.ipynb
          retention-days: 1
  test_docs_combine:
    runs-on: ubuntu-latest
    needs: [nb-no-run, nb]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v3
        with:
          path: |
            ~/.gdsfactory/
          key: 0.0.1
          restore-keys: 0.0.1
      - uses: conda-incubator/setup-miniconda@v2
        with:
          python-version: '3.10'
          mamba-version: "*"
          conda-version: '23.7.4'
          channels: conda-forge,defaults
          channel-priority: true
          activate-environment: anaconda-client-env
      - name: Add conda to system path
        run: |
          echo $CONDA/bin >> $GITHUB_PATH
      - uses: actions/download-artifact@v3
        with:
          name: notebooks
      - name: Install dependencies
        run: |
          make dev meep docs
      - name: Expose docs artifact
        uses: actions/upload-artifact@v3
        with:
          name: docs
          path: docs/_build/html/
